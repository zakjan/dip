\chapter{OpenSSL}

OpenSSL\footnote{\url{https://www.openssl.org}} is an opensource cryptographic toolkit, consisting of implementations of many cryptographic aslgorithms, all versions of TLS protocol and various command-line tools.

It is free to get and use for both non-commercial and commercial purposes, with some simple licence conditions\footnote{\url{https://www.openssl.org/source/license.html}}.


\section{Download, build, test, install}

Download the source code from the official OpenSSL homepage\footnote{\url{https://www.openssl.org/source/}} and compare its hash fingerprints. The latest version in the time of writing is 1.0.2a.

Compile it with commands:

\begin{minted}{text}
./config
make
\end{minted}

It results into an all-in-one \texttt{apps/openssl} binary. You can run attached tests with \texttt{make test} command. If you wish to install it globally to your system, run \texttt{make install} command with root privileges.

While making changes into OpenSSL code, sometimes I needed to debug the binary with GDB. You can turn on debugging symbols with \texttt{./config -d} command and build again.


\section{Source code}

OpenSSL source code contains a lot of various directories, for my purposes only the following are significant:

\begin{itemize}
  \item \texttt{apps} -- command-line tools
  \item \texttt{crypto} -- \textit{libcrypto} cryptographic library
  \item \texttt{ssl} -- \textit{libssl} TLS protocol library
  \item \texttt{demos} -- examples
  \item \texttt{docs} -- man pages and howtos
  \item \texttt{include} -- include header files
  \item \texttt{util} -- perl scripts for C code generation
\end{itemize}


\subsection{apps}
\subsection{crypto}
\subsection{ssl}


\section{Command-line interface}

OpenSSL is primarily a library that is used by developers to include support for strong cryptography in their programs. However it is also a tool that provides access to much of its functionality from command line. This way it can be used by shell scripts or programming languages that do not have native bindings, but can run shell commands.

The CLI executable \texttt{openssl} has two modes of operation: interactive and batch. When the program is started without any options, it will enter interactive mode. A prompt is displayed indicating that it is ready to process your command. After each command is completed, the prompt is redisplayed, and it's once again ready to process another command. Commands entered in interactive mode are handled in precisely the same manner as if you'd entered them from the command line in batch mode, the only difference is that you don't need to type the name of executable before each command. However it is more common and illustrative to use the tool in batch mode.

In the batch mode, the program command is followed by a specific OpenSSL command and any options, each one separated by a space. Options normally begin with a hyphen and often require a parameter of their own, in which case the parameter is placed after a space. Unless indicated otherwise, the order in which you specify options is not significant. There are only a small number of cases in which the order is significant, usually because a specific option must appear on the command line as the last option specified. \cite[p.~23]{viega2002network}

OpenSSL CLI provides access to the following significant cryptographic operations and applications:

\begin{itemize}
  \item \texttt{openssl list-standard-commands} -- list of all CLI commands
  \item \texttt{openssl dgst} -- a message digest command, producing or verifying a digest of supplied file(s) using hash functions or digital signature algorithms
  \item \texttt{openssl enc} -- a symmetric cipher command, allowing data to be encrypted or decrypted using various block and stream ciphers, using keys derivated from passwords or explicitly provided
  \item \texttt{openssl speed} -- a benchmark to test the performance of all included cryptographic algorithms
  \item \texttt{openssl asn1parse} -- a diagnostic parser of ASN.1 encoded structures; public and private keys, certificates and other cryptographic structures are usually stored in ASN.1 format
  \item \texttt{openssl x509} -- a multi-purpose utility to operate with X509 certificates
  \item \texttt{openssl s\_server} -- a generic TCP+TLS server which listens on a given local port, it can operate either in plain text mode, or as a simple HTTP server, processing requests and responding with files in current directory
  \item \texttt{openssl s\_client} -- a generic TCP+TLS client which connects to a remote host, very useful diagnostic tool
  \item \texttt{openssl s\_time} -- a client which benchmarks the performance of a TLS connection
\end{itemize}

OpenSSL supports a lot of cryptographic algorithms, some of them also have their own aliases (pseudo-commands) for faster command line access. Supported algorithms and their corresponding pseudo-commands can be listed by the following commands:

\begin{itemize}
  \item \texttt{openssl list-message-digest-algorithms} -- list of message digest algorithms
  \item \texttt{openssl list-message-digest-commands} -- list of message digest pseudo-commands
  \item \texttt{openssl list-cipher-algorithms} -- list of symmetric encryption algorithms
  \item \texttt{openssl list-cipher-commands} -- list of symmetric encryption pseudo-commands
  \item \texttt{openssl list-public-key-algorithms} -- list of public key algorithms
  \item \texttt{openssl ecparam -list\_curves} -- list of named elliptic curves
\end{itemize}


\subsection{Symmetric encryption}

The \texttt{openssl enc} command\footnote{\url{https://www.openssl.org/docs/apps/enc.html}} encrypts or decrypts given data using various supported ciphers. By default, it reads the data from standard input, a writes to standard output.

It accepts the following significant options:

\begin{itemize}
  \item \texttt{-\textit{ciphername}} -- the cipher name, it specifies the requirements on the length of key and IV
  \item \texttt{-d} -- decrypt the input data
  \item \texttt{-K \textit{hex}} -- the key used in cipher, it must be represented as a string comprised only of hex digits
  \item \texttt{-iv \textit{hex}} -- the IV used in cipher, it must be represented as a string comprised only of hex digits
\end{itemize}

Example:

\inputminted{text}{code/openssl-enc-example.txt}


\subsection{Performance benchmarking of cryptographic algorithms}

The \texttt{openssl speed} command\footnote{\url{https://www.openssl.org/docs/apps/speed.html}} can run performance benchmarks of all included cryptographic algorithms - hash functions, symmetric ciphers, assymetric key exchanges and digital signatures.

It accepts the following significant options:

\begin{itemize}
  \item \texttt{-evp \textit{algorithmname}} -- run benchmarks on an EVP algorithm
  \item \texttt{\textit{algorithmnames}} -- if any algorithms are given, speed tests those algorithms, otherwise all are tested
\end{itemize}

Example:

\inputminted{text}{code/openssl-speed-example.txt}


\subsection{Generic server}

The \texttt{openssl s\_server} command\footnote{\url{https://www.openssl.org/docs/apps/s\_server.html}} emulates a generic TCP server, which uses TLS to ensure a secure communication channel. It listens for incoming connections and after a connection is established, it forwards standard input to the opposite party through TLS data protocol, and writes all received data to standard output.

It accepts the following significant options:

\begin{itemize}
  \item \texttt{-accept \textit{port}} -- the port to listen on for connections, 4433 by default
  \item \texttt{-cert \textit{filename}} -- the certificate, a self-signed certificate can be used
  \item \texttt{-key \textit{filename}} -- the certificate private key
  \item \texttt{-cipher \textit{ciphernames}} -- the supported cipher list. When the client sends a list of supported ciphers, the first client cipher also included in the server list is chosen. Because the client specifies the preference order, the order of the server cipherlist irrelevant. This behavior can be overriden by \texttt{-serverpref} option.
  \item \texttt{-serverpref} -- use the server's cipher preferences, rather than the client's preferences
  \item \texttt{-WWW} -- emulates a simple web server. Resources will be resolved relative to the current directory, for example if the resource \texttt{/page.html} is requested, the file \texttt{./page.html} will be loaded.
\end{itemize}

Example, run in parallel with \texttt{s\_client} example:

\inputminted{text}{code/openssl-s_server-example.txt}

After the connection is established, a string "Lorem ipsum..." is successfully transferred from the client to the server.


\subsection{Generic client}

The \texttt{openssl s\_client} command\footnote{\url{https://www.openssl.org/docs/apps/s\_client.html}} emulates a generic TCP client, which uses TLS to ensure a secure communication channel. After a connection is established, it forwards standard input to the opposite party through TLS data protocol, and writes all received data to standard output.

It accepts the following significant options:

\begin{itemize}
\item \texttt{-connect \textit{host:port}} -- the host and port to connect to, local host and port 4433 by default
\item \texttt{-cipher \textit{ciphernames}} -- the supported cipher list. Although the server determines which cipher suite is used, it should take the first supported cipher in the list sent by the client.
\end{itemize}

Example, run in parallel with \texttt{s\_server} example:

\inputminted{text}{code/openssl-s_client-example.txt}

After the connection is established, a string "Lorem ipsum..." is successfully transferred from the client to the server.


\subsection{Performance benchmarking of TLS}

The \texttt{openssl s\_time} command\footnote{\url{https://www.openssl.org/docs/apps/s\_time.html}} emulates a generic TCP client, which uses TLS to ensure a secure communication channel. It can request a page from the server and includes the time to transfer the payload data in its timing measurements. It measures the number of connections within a given timeframe, the amount of data transferred (if any), and calculates the average time spent for one connection.

It accepts the following significant options:

\begin{itemize}
  \item \texttt{-connect \textit{host:port}} -- the host and port to connect to, local host and port 4433 by default
  \item \texttt{-cipher \textit{ciphernames}} -- the supported cipher list. Although the server determines which cipher suite is used, it should take the first supported cipher in the list sent by the client.
  \item \texttt{-time \textit{sec}} -- specifies how long in seconds the benchmark should run
  \item \texttt{-new} -- performs the timing test using a new session for each connection. If \texttt{-www} option is not used, this can be used to benchmark specifically the TLS handshake protocol.
  \item \texttt{-reuse} -- performs the timing test using the same session for each connection. If \texttt{-www} option is not used, this can be used to benchmark specifically the TLS handshake protocol with session resume.
  \item \texttt{-www \textit{filename}} -- this specifies the resource to GET from the server. If this parameter is not specified, then it will only perform the TLS handshake to establish a connections, but not transfer any data.
\end{itemize}

\inputminted{text}{code/openssl-s_time-example.txt}


\section{EVP API}
